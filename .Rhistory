### decreaseing secondary outcomes.
library(tidyverse)
library(tidylog)
library(lme4)
set.seed(123)
## sampling improvement and times/icus
n_icu  <- 30
n_pre  <- 16
n_post <- 13
n_time <- n_pre + n_post
icu_df <- data.frame(
icu = factor(1:n_icu),
max_improve = runif(n_icu, 10, 40),   # final % improvement
uptake_rate = runif(n_icu, 0.15, 0.5) # speed of implementation
)
icu_df$baseline_x <- runif(n_icu, 0, 5)       # small baseline % (0–5%)
icu_df$pre_trend  <- runif(n_icu, -0.05, 0.1) # weak pre-trend per week
## Time structure
time_df <- expand.grid(
icu = icu_df$icu,
week = 1:n_time
)
time_df$post <- ifelse(time_df$week > n_pre, 1, 0)
time_df$time <- time_df$week
time_df$time_post <- pmax(0, time_df$week - n_pre)
dat <- merge(time_df, icu_df, by = "icu")
# generate time varying improvement
dat$x_baseline <- with(dat,
baseline_x + pre_trend * time
)
dat$x_baseline <- pmax(0, dat$x_baseline)
dat$x_improve <- with(dat,
ifelse(
post == 1,
x_baseline + max_improve * (1 - exp(-uptake_rate * time_post)),
x_baseline
)
)
dat$x_improve <- dat$x_improve + rnorm(nrow(dat), 0, 1)
dat$x_improve <- pmax(0, dat$x_improve)
## check
ggplot(dat, aes(time, x_improve, group = icu)) +
geom_line(alpha = 0.3) +
geom_vline(xintercept = n_pre, linetype = "dashed") +
labs(
y = "Implementation intensity (%)",
x = "Week",
title = "ICU-specific implementation trajectories"
)
# simulating AD
# Fixed effects
beta_0      <- 80      # baseline AD
beta_time   <- -0.1    # secular trend
beta_post   <- -3      # immediate intervention effect
beta_x      <- -0.35   # effect per % improvement in X(t)
# Random intercepts
icu_intercept <- rnorm(n_icu, 0, 6)
names(icu_intercept) <- levels(dat$icu)
dat$AD <- beta_0 +
icu_intercept[dat$icu] +
beta_time * dat$time +
beta_post * dat$post +
beta_x * dat$x_improve +
rnorm(nrow(dat), 0, 4)
mod_fe <- lmerTest::lmer(
AD ~ time + post + x_improve + factor(icu),
data = dat
)
mod_fe <- lm(
AD ~ time + post + x_improve + factor(icu),
data = dat
)
summary(mod_fe)
## hybrid models
dat$x_improve_wc <- dat$x_improve - ave(dat$x_improve, dat$icu)
library(tidyverse)
library(tidylog)
library(lme4)
set.seed(123)
## sampling improvement and times/icus
n_icu  <- 30
n_pre  <- 16
n_post <- 13
n_time <- n_pre + n_post
icu_df <- data.frame(
icu = factor(1:n_icu),
max_improve = runif(n_icu, 10, 40),   # final % improvement
uptake_rate = runif(n_icu, 0.15, 0.5) # speed of implementation
)
icu_df$baseline_x <- runif(n_icu, 0, 5)       # small baseline % (0–5%)
icu_df$pre_trend  <- runif(n_icu, -0.05, 0.1) # weak pre-trend per week
## Time structure
time_df <- expand.grid(
icu = icu_df$icu,
week = 1:n_time
)
time_df$post <- ifelse(time_df$week > n_pre, 1, 0)
time_df$time <- time_df$week
time_df$time_post <- pmax(0, time_df$week - n_pre)
dat <- merge(time_df, icu_df, by = "icu")
# generate time varying improvement
dat$x_baseline <- with(dat,
baseline_x + pre_trend * time
)
dat$x_baseline <- pmax(0, dat$x_baseline)
dat$x_improve <- with(dat,
ifelse(
post == 1,
x_baseline + max_improve * (1 - exp(-uptake_rate * time_post)),
x_baseline
)
)
dat$x_improve <- dat$x_improve + rnorm(nrow(dat), 0, 1)
dat$x_improve <- pmax(0, dat$x_improve)
## check
ggplot(dat, aes(time, x_improve, group = icu)) +
geom_line(alpha = 0.3) +
geom_vline(xintercept = n_pre, linetype = "dashed") +
labs(
y = "Implementation intensity (%)",
x = "Week",
title = "ICU-specific implementation trajectories"
)
# simulating AD
# Fixed effects
beta_0      <- 80      # baseline AD
beta_time   <- -0.1    # secular trend
beta_post   <- -3      # immediate intervention effect
beta_x      <- -0.35   # effect per % improvement in X(t)
# Random intercepts
icu_intercept <- rnorm(n_icu, 0, 6)
names(icu_intercept) <- levels(dat$icu)
dat$AD <- beta_0 +
icu_intercept[dat$icu] +
beta_time * dat$time +
beta_post * dat$post +
beta_x * dat$x_improve +
rnorm(nrow(dat), 0, 4)
## model with fixed effects
## within ICU ITS similar modelling
## immediate before-after level (post)
## secular trend (time)
## time_post (change in slope)
## x-improve: Within-ICU effect of implementation intensity, beyond time
mod_fe_1 <- lm(
AD ~ time + post + time_post + x_improve + factor(icu),
data = dat
)
summary(mod_fe_1)
## model with fixed effects
## within ICU ITS similar modelling
## immediate before-after level (post) (no neened if not expected)
## secular trend (time)
## time_post (change in slope)
## x-improve: Within-ICU effect of implementation intensity, beyond time
mod_fe_2 <- lm(
AD ~ time + time_post + x_improve + factor(icu),
data = dat
)
summary(mod_fe_2)
## hybrid models
dat$x_improve_wc <- dat$x_improve - ave(dat$x_improve, dat$icu)
mod_within <- lmerTest::lmer(
AD ~ time + post + time_post + x_improve_wc + (1 | icu),
data = dat
)
summary(mod_within)
## hybrid models - mundlack
dat$x_mean <- ave(dat$x_improve, dat$icu)
dat$x_wc   <- dat$x_improve - dat$x_mean
mod_within_mundlack <- lmerTest::lmer(
AD ~ time + post + time_post + x_mean + x_improve_wc + (1 | icu),
data = dat
)
summary(mod_within_mundlack)
library(sandwich)
library(lmtest)
coeftest(
mod_fe_1,
vcov = vcovCL(mod_fe_1, cluster = ~ icu)
)
ave(dat$x_improve, dat$icu)
### simulating implementation and model
### main idea is to see the association between improving the implementation and
### decreaseing secondary outcomes.
library(tidyverse)
library(tidylog)
library(lme4)
set.seed(123)
## sampling improvement and times/icus
n_icu  <- 30
n_pre  <- 16
n_post <- 13
n_time <- n_pre + n_post
icu_df <- data.frame(
icu = factor(1:n_icu),
max_improve = runif(n_icu, 10, 40),   # final % improvement
uptake_rate = runif(n_icu, 0.15, 0.5) # speed of implementation
)
icu_df$baseline_x <- runif(n_icu, 0, 5)       # small baseline % (0–5%)
icu_df$pre_trend  <- runif(n_icu, -0.05, 0.1) # weak pre-trend per week
## Time structure
time_df <- expand.grid(
icu = icu_df$icu,
week = 1:n_time
)
time_df$post <- ifelse(time_df$week > n_pre, 1, 0)
time_df$time <- time_df$week
time_df$time_post <- pmax(0, time_df$week - n_pre)
dat <- merge(time_df, icu_df, by = "icu")
# generate time varying improvement
dat$x_baseline <- with(dat,
baseline_x + pre_trend * time
)
dat$x_baseline <- pmax(0, dat$x_baseline)
dat$x_improve <- with(dat,
ifelse(
post == 1,
x_baseline + max_improve * (1 - exp(-uptake_rate * time_post)),
x_baseline
)
)
dat$x_improve <- dat$x_improve + rnorm(nrow(dat), 0, 1)
dat$x_improve <- pmax(0, dat$x_improve)
## check
ggplot(dat, aes(time, x_improve, group = icu)) +
geom_line(alpha = 0.3) +
geom_vline(xintercept = n_pre, linetype = "dashed") +
labs(
y = "Implementation intensity (%)",
x = "Week",
title = "ICU-specific implementation trajectories"
)
# simulating AD
# Fixed effects
beta_0      <- 80      # baseline AD
beta_time   <- -0.1    # secular trend
beta_post   <- -3      # immediate intervention effect
beta_x      <- -0.35   # effect per % improvement in X(t)
# Random intercepts
icu_intercept <- rnorm(n_icu, 0, 6)
names(icu_intercept) <- levels(dat$icu)
dat$AD <- beta_0 +
icu_intercept[dat$icu] +
beta_time * dat$time +
beta_post * dat$post +
beta_x * dat$x_improve +
rnorm(nrow(dat), 0, 4)
## model with fixed effects
## within ICU ITS similar modelling
## immediate before-after level (post)
## secular trend (time)
## time_post (change in slope)
## x-improve: Within-ICU effect of implementation intensity, beyond time
mod_fe_1 <- lm(
AD ~ time + post + time_post + x_improve + factor(icu),
data = dat
)
summary(mod_fe_1)
## allow for robust SE
library(sandwich)
library(lmtest)
coeftest(
mod_fe_1,
vcov = vcovCL(mod_fe_1, cluster = ~ icu)
)
## model with fixed effects
## within ICU ITS similar modelling
## immediate before-after level (post) (no neened if not expected)
## secular trend (time)
## time_post (change in slope)
## x-improve: Within-ICU effect of implementation intensity, beyond time
mod_fe_2 <- lm(
AD ~ time + time_post + x_improve + factor(icu),
data = dat
)
summary(mod_fe_2)
## hybrid models
dat$x_improve_wc <- dat$x_improve - ave(dat$x_improve, dat$icu)
mod_within <- lmerTest::lmer(
AD ~ time + post + time_post + x_improve_wc + (1 | icu),
data = dat
)
summary(mod_within)
## hybrid models - mundlack
dat$x_improve_mean <- ave(dat$x_improve, dat$icu)
mod_within_mundlack <- lmerTest::lmer(
AD ~ time + post + time_post + x_mean + x_improve_wc + (1 | icu),
data = dat
)
### simulating implementation and model
### main idea is to see the association between improving the implementation and
### decreaseing secondary outcomes.
library(tidyverse)
library(tidylog)
library(lme4)
set.seed(123)
## sampling improvement and times/icus
n_icu  <- 30
n_pre  <- 16
n_post <- 13
n_time <- n_pre + n_post
icu_df <- data.frame(
icu = factor(1:n_icu),
max_improve = runif(n_icu, 10, 40),   # final % improvement
uptake_rate = runif(n_icu, 0.15, 0.5) # speed of implementation
)
icu_df$baseline_x <- runif(n_icu, 0, 5)       # small baseline % (0–5%)
icu_df$pre_trend  <- runif(n_icu, -0.05, 0.1) # weak pre-trend per week
## Time structure
time_df <- expand.grid(
icu = icu_df$icu,
week = 1:n_time
)
time_df$post <- ifelse(time_df$week > n_pre, 1, 0)
time_df$time <- time_df$week
time_df$time_post <- pmax(0, time_df$week - n_pre)
dat <- merge(time_df, icu_df, by = "icu")
# generate time varying improvement
dat$x_baseline <- with(dat,
baseline_x + pre_trend * time
)
dat$x_baseline <- pmax(0, dat$x_baseline)
dat$x_improve <- with(dat,
ifelse(
post == 1,
x_baseline + max_improve * (1 - exp(-uptake_rate * time_post)),
x_baseline
)
)
dat$x_improve <- dat$x_improve + rnorm(nrow(dat), 0, 1)
dat$x_improve <- pmax(0, dat$x_improve)
## check
ggplot(dat, aes(time, x_improve, group = icu)) +
geom_line(alpha = 0.3) +
geom_vline(xintercept = n_pre, linetype = "dashed") +
labs(
y = "Implementation intensity (%)",
x = "Week",
title = "ICU-specific implementation trajectories"
)
# simulating AD
# Fixed effects
beta_0      <- 80      # baseline AD
beta_time   <- -0.1    # secular trend
beta_post   <- -3      # immediate intervention effect
beta_x      <- -0.35   # effect per % improvement in X(t)
# Random intercepts
icu_intercept <- rnorm(n_icu, 0, 6)
names(icu_intercept) <- levels(dat$icu)
dat$AD <- beta_0 +
icu_intercept[dat$icu] +
beta_time * dat$time +
beta_post * dat$post +
beta_x * dat$x_improve +
rnorm(nrow(dat), 0, 4)
## model with fixed effects
## within ICU ITS similar modelling
## immediate before-after level (post)
## secular trend (time)
## time_post (change in slope)
## x-improve: Within-ICU effect of implementation intensity, beyond time
mod_fe_1 <- lm(
AD ~ time + post + time_post + x_improve + factor(icu),
data = dat
)
summary(mod_fe_1)
## allow for robust SE
library(sandwich)
library(lmtest)
coeftest(
mod_fe_1,
vcov = vcovCL(mod_fe_1, cluster = ~ icu)
)
## model with fixed effects
## within ICU ITS similar modelling
## immediate before-after level (post) (no neened if not expected)
## secular trend (time)
## time_post (change in slope)
## x-improve: Within-ICU effect of implementation intensity, beyond time
mod_fe_2 <- lm(
AD ~ time + time_post + x_improve + factor(icu),
data = dat
)
summary(mod_fe_2)
## hybrid models
dat$x_improve_wc <- dat$x_improve - ave(dat$x_improve, dat$icu)
mod_within <- lmerTest::lmer(
AD ~ time + post + time_post + x_improve_wc + (1 | icu),
data = dat
)
summary(mod_within)
## hybrid models - mundlack
dat$x_improve_mean <- ave(dat$x_improve, dat$icu)
mod_within_mundlack <- lmerTest::lmer(
AD ~ time + post + time_post + x_improve_mean + x_improve_wc + (1 | icu),
data = dat
)
summary(mod_within_mundlack)
### FE PANEL DATA withou considering intervention per se, to explore
mod_within_lm <- lm(AD ~ x_improve_wc + time + factor(icu), data = dat)
summary(mod_within_lm)
## x_wc: within-ICU intensity effect (causal target)
## x_mean: between-ICU differences (confounding diagnostic)
## Packages
library(tidyverse)
library(MASS)        # glm.nb
library(glmmTMB)     # mixed-effects NB
library(sandwich)    # robust SEs
library(lmtest)
set.seed(123)
n_icu  <- 30
n_pre  <- 16
n_post <- 13
n_time <- n_pre + n_post
icu_df <- tibble(
icu          = factor(1:n_icu),
max_improve  = runif(n_icu, 10, 40),    # final % implementation intensity
uptake_rate = runif(n_icu, 0.15, 0.5),  # speed of uptake
baseline_x  = runif(n_icu, 0, 5),       # baseline implementation (%)
pre_trend   = runif(n_icu, -0.05, 0.1)  # weak pre-intervention drift
)
time_df <- expand.grid(
icu  = icu_df$icu,
week = 1:n_time
) %>%
mutate(
post      = ifelse(week > n_pre, 1, 0),
time      = week,
time_post = pmax(0, week - n_pre)
)
dat <- left_join(time_df, icu_df, by = "icu")
dat$x_baseline <- with(dat, baseline_x + pre_trend * time)
dat$x_baseline <- pmax(0, dat$x_baseline)
dat$x_improve <- with(dat,
ifelse(
post == 1,
x_baseline + max_improve * (1 - exp(-uptake_rate * time_post)),
x_baseline
)
)
## Add random noise
dat$x_improve <- dat$x_improve + rnorm(nrow(dat), 0, 1)
dat$x_improve <- pmax(0, dat$x_improve)
dat$patient_days <- round(runif(nrow(dat), 400, 1200))
## True parameters (log scale)
beta_0    <- log(80 / 1000)   # baseline rate per 1000 patient-days
beta_time <- -0.01            # secular trend
beta_post <- -0.15            # immediate intervention effect
beta_x    <- -0.025           # effect per % improvement
theta     <- 1.2              # overdispersion
## ICU random intercepts
icu_re <- rnorm(n_icu, 0, 0.35)
names(icu_re) <- levels(dat$icu)
## Linear predictor
linpred <- beta_0 +
icu_re[dat$icu] +
beta_time * dat$time +
beta_post * dat$post +
beta_x * dat$x_improve +
log(dat$patient_days / 1000)
## Expected mean
mu <- exp(linpred)
## Generate counts
dat$AD_count <- rnbinom(nrow(dat), mu = mu, size = theta)
mod_nb_fe <- glm.nb(
AD_count ~ time + post + time_post + x_improve +
factor(icu) +
offset(log(patient_days)),
data = dat
)
summary(mod_nb_fe)
## Cluster-robust SEs (ICU level)
coeftest(
mod_nb_fe,
vcov = vcovCL(mod_nb_fe, cluster = ~ icu)
)
## Within-ICU centering
dat$x_improve_wc <- dat$x_improve - ave(dat$x_improve, dat$icu)
mod_nb_within <- glmmTMB(
AD_count ~ time + post + time_post + x_improve_wc +
offset(log(patient_days)) +
(1 | icu),
family = nbinom2,
data = dat
)
summary(mod_nb_within)
dat$x_improve_mean <- ave(dat$x_improve, dat$icu)
mod_nb_mundlak <- glmmTMB(
AD_count ~ time + post + time_post +
x_improve_wc + x_improve_mean +
offset(log(patient_days)) +
(1 | icu),
family = nbinom2,
data = dat
)
summary(mod_nb_mundlak)
mod_nb_fe_simple <- glm.nb(
AD_count ~ x_improve_wc + time + factor(icu) +
offset(log(patient_days)),
data = dat
)
summary(mod_nb_fe_simple)
ggplot(dat, aes(time, x_improve, group = icu)) +
geom_line(alpha = 0.3) +
geom_vline(xintercept = n_pre, linetype = "dashed") +
labs(
y = "Implementation intensity (%)",
x = "Week",
title = "ICU-specific implementation trajectories"
) +
theme_bw()
